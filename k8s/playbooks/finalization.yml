- hosts: ctrl
  become: true
  
  become_user: vagrant
  
  vars:
    metallb_ip_range: "192.168.56.90-192.168.56.99"
    
    nginx_ingress_ip: "192.168.56.91"
    istio_gateway_ip: "192.168.56.92"

    # Files paths
    metallb_manifest_url: "https://raw.githubusercontent.com/metallb/metallb/v0.14.9/config/manifests/metallb-native.yaml"
    local_pool_config: "files/metallb_adpool.yaml"
    remote_pool_config: "/home/vagrant/metallb-adpool.yaml"

  tasks:
    # Step 20: Install MetalLB
    - name: Enable strict ARP in kube-proxy config
      shell: |
        kubectl get configmap kube-proxy -n kube-system -o yaml | \
        sed -e "s/strictARP: false/strictARP: true/" | \
        kubectl apply -f - -n kube-system
      ignore_errors: true


    - name: Install MetalLB Manifests
      shell: "kubectl apply -f {{ metallb_manifest_url }}"
      register: install_metallb
      changed_when: "'created' in install_metallb.stdout or 'configured' in install_metallb.stdout" #mark this task has no change or already stared when there is no such two 'words' be catched

    - name: Wait for MetalLB Controller to be Ready
      shell: >
        kubectl wait --namespace metallb-system 
        --for=condition=ready pod 
        --selector=app=metallb,component=controller 
        --timeout=90s
      retries: 5
      delay: 10
      register: wait_result
      until: wait_result.rc == 0

    - name: Copy MetalLB Pool Config to VM
      copy:
        src: "{{ local_pool_config }}"
        dest: "{{ remote_pool_config }}"
        owner: vagrant
        group: vagrant
        mode: '0644'

    - name: Apply MetalLB Pool Configuration #configure L2Advertisement and IPAddressPool
      shell: "kubectl apply -f {{ remote_pool_config }}"

    # Step 21: Install Nginx Ingress Controller

    - name: Add Helm repository
      shell: helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
      register: repo_add
      changed_when: repo_add.rc == 0

    - name: Update Helm repositories
      shell: helm repo update
      changed_when: false

    # --set controller.service.loadBalancerIP={{ nginx_ingress_ip }}: 
    # specify the static IP for LoadBalancer service("192.168.56.91")

    - name: Install Nginx Ingress Controller
      shell: >
        helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx
        --namespace ingress-nginx
        --create-namespace
        --set controller.service.loadBalancerIP={{ nginx_ingress_ip }} 
      register: install_nginx
      changed_when: "'rendered' in install_nginx.stdout or 'DEPLOYED' in install_nginx.stdout or 'UPGRADED' in install_nginx.stdout"

    - name: Wait for Ingress Controller IP assignment
      shell: >
        kubectl wait --namespace ingress-nginx 
        --for=jsonpath='{.status.loadBalancer.ingress[0].ip}'="{{ nginx_ingress_ip }}" 
        service/ingress-nginx-controller 
        --timeout=90s
      retries: 5
      delay: 10
      register: wait_nginx_ip
      until: wait_nginx_ip.rc == 0

    # we need to wait for the iginx pods to be ready. 
    - name: Wait for Nginx Ingress Controller Pods to be Ready
      shell: >
        kubectl wait --namespace ingress-nginx 
        --for=condition=ready pod 
        --selector=app.kubernetes.io/component=controller 
        --timeout=120s
      retries: 5
      delay: 10
      register: wait_ingress_pods
      until: wait_ingress_pods.rc == 0

    # Step 22: Install Kubernetes Dashboard
    - name: Add kubernets dashboard
      shell: helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
      register: add_dashboard_repo
      changed_when: add_dashboard_repo.rc == 0

    - name: Update Helm repositories
      shell: helm repo update
      changed_when: false

    # step 23: Install Istio
    - name: Determine CPU Architecture
      set_fact:
        istio_arch: "{{ 'arm64' if ansible_facts['architecture'] == 'aarch64' else 'amd64' }}"

    - name: Create temporary directory for download
      ansible.builtin.file:
        path: "tmp/istio-download"
        state: directory
        mode: '0755'

    - name: Download Istio
      get_url:
        url: "https://github.com/istio/istio/releases/download/1.25.2/istio-1.25.2-linux-{{ istio_arch }}.tar.gz"
        dest: "tmp/istio-1.25.2-linux-{{ istio_arch }}.tar.gz"
        mode: '0644'
        force: yes

    # - name: Remove existing Istio directory
    #   file:
    #     path: "/opt/istio-1.25.2"
    #     state: absent
    #   become_user: root

    - name: Extract Istio to /opt
      unarchive:
        src: "tmp/istio-1.25.2-linux-{{ istio_arch }}.tar.gz"
        dest: "/opt"
        remote_src: yes
      become_user: root

    - name: Change ownership of Istio directory to vagrant
      file:
        path: "/opt/istio-1.25.2"
        owner: vagrant
        group: vagrant
        recurse: yes
      become_user: root

    - name: Link istioctl to system path
      file:
        src: "/opt/istio-1.25.2/bin/istioctl"
        dest: "/usr/local/bin/istioctl"
        state: link
      become_user: root

    - name: Create IstioOperator
      copy:
        dest: "/home/vagrant/istio-config.yaml"
        owner: vagrant
        group: vagrant
        mode: '0644'
        content: |
          apiVersion: install.istio.io/v1alpha1
          kind: IstioOperator
          spec:
            profile: demo
            components:
              ingressGateways:
                - name: istio-ingressgateway
                  enabled: true
                  k8s:
                    service:
                      loadBalancerIP: {{ istio_gateway_ip }}

    - name: Install Istio with IstioOperator
      shell: >
        /usr/local/bin/istioctl install -y -f /home/vagrant/istio-config.yaml
      register: istio_install
      changed_when: "'Installation complete' in istio_install.stdout"
      environment:
        KUBECONFIG: /home/vagrant/.kube/config
      become: yes
      become_user: vagrant

    - name: Enable Istio sidecar injection for default namespace
      shell: kubectl label namespace default istio-injection=enabled --overwrite
      register: istio_label
      changed_when: "'labeled' in istio_label.stdout"

    - name: Install Kubernetes Dashboard
      shell: >
        helm upgrade --install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard 
        --namespace kubernetes-dashboard 
        --create-namespace
      register: install_dashboard
      changed_when: "'installed' in install_dashboard.stdout or 'upgraded' in install_dashboard.stdout"

    # login to the dashboard with admin-user
    # mode 0644: 6-> vagrant read & write; 4-> group only read; 4-> others read only
    - name: Copy Dashboard Admin User Config to VM
      copy:
        src: "files/dashboard-admin-user.yaml"
        dest: "/home/vagrant/dashboard-admin-user.yaml"
        owner: vagrant
        group: vagrant
        mode: '0644'
    - name: Apply Dashboard Admin User Configuration
      shell: "kubectl apply -f /home/vagrant/dashboard-admin-user.yaml"

    # Create an ingress to provide convenient access to the dashboard
    - name: Copy Dashboard Ingress Config to VM
      copy: 
        src: "files/dashboard-ingress.yaml"
        dest: "/home/vagrant/dashboard-ingress.yaml"
        owner: vagrant
        group: vagrant
        mode: '0644'
    - name: Apply Dashboard Ingress Configuration
      shell: "kubectl apply -f /home/vagrant/dashboard-ingress.yaml"

    # generate the login token for admin-user
    - name: Generate and Print Admin User Token
      shell: >
        kubectl -n kubernetes-dashboard 
        create token admin-user
      register: admin_user_token
      changed_when: false
    - name: Display Admin User Token
      debug:
        msg: "Kubernetes Dashboard Admin User Token: {{ admin_user_token.stdout }}"
